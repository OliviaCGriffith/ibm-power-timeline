<!-- Cleaned & Optimized IBM Power Timeline Tool -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IBM Power Timeline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.11.0/dist/pptxgen.bundle.js"></script>
</head>
<body class="bg-gray-50">
<div id="root"></div>

<script type="text/babel">
/****************************
 * Utility Functions
 ****************************/
const addDays = (date, days) => {
  const d = new Date(date);
  d.setDate(d.getDate() + days);
  return d;
};

const addWeeks = (date, weeks) => addDays(date, weeks * 7);

const calcWeeks = (count) => {
  const c = Number(count) || 0;
  if (c === 0) return 0;
  if (c <= 10) return 1;
  if (c <= 20) return 2;
  return 3;
};

const fmt = (d) => (d instanceof Date ? d.toLocaleDateString() : "");

/****************************
 * Main Wizard Component
 ****************************/
function IBMWizard() {
  const { useState } = React;

  const [step, setStep] = useState(1);
  const [mode, setMode] = useState(null);
  const [timeline, setTimeline] = useState(null);
  const [error, setError] = useState("");

  const [form, setForm] = useState({
    poDate: "",
    endMigrationDate: "",
    s1022: 0,
    s1024: 0,
    e1050: 0,
    e1080: 0,
    lpars: 0
  });

  const handleChange = (e) => {
    const { name, value, type } = e.target;
    setForm((prev) => ({
      ...prev,
      [name]: type === "range" || type === "number" ? Number(value) : value
    }));
  };

  /****************************
   * Input Validation
   ****************************/
  const validateInputs = () => {
    if (!mode) {
      setError("Please choose PO Received Date OR End of Migration Date.");
      return false;
    }
    if (mode === "po" && !form.poDate) {
      setError("Please enter the PO Received Date.");
      return false;
    }
    if (mode === "end" && !form.endMigrationDate) {
      setError("Please enter the End of Migration Date.");
      return false;
    }
    setError("");
    return true;
  };

  /****************************
   * Timeline Generator
   ****************************/
  const generateTimeline = () => {
    if (!validateInputs()) return;

    let po, buildShip, install, endMigration;

    if (mode === "po") {
      po = new Date(form.poDate + "T00:00:00");

      buildShip = addDays(po, 21);
      install = new Date(buildShip);

      install = addWeeks(install, calcWeeks(form.s1022));
      install = addWeeks(install, calcWeeks(form.s1024));
      install = addWeeks(install, calcWeeks(form.e1050));
      install = addWeeks(install, calcWeeks(form.e1080));

      endMigration = addDays(
        install,
        5 + Math.floor((form.lpars || 0) / 12)
      );
    } else {
      // User entered END OF MIGRATION DATE — correct back‑calculation
      endMigration = new Date(form.endMigrationDate + "T00:00:00");

      // Back out LPAR migration
      install = addDays(
        endMigration,
        -(5 + Math.floor((form.lpars || 0) / 12))
      );

      // Back out server build timelines
      install = addWeeks(install, -calcWeeks(form.e1080));
      install = addWeeks(install, -calcWeeks(form.e1050));
      install = addWeeks(install, -calcWeeks(form.s1024));
      install = addWeeks(install, -calcWeeks(form.s1022));

      // Build/Ship is 21 days before install
      buildShip = addDays(install, -21);

      // TRUE PO date = buildShip − 21 days
      po = addDays(buildShip, -21);
    }

    setTimeline({ po, buildShip, install, endMigration });
    setStep(3);
  };

  /****************************
   * PPT Download
   ****************************/
  const downloadPPT = async () => {
    if (!timeline) return alert("Generate the timeline first.");

    const Pctor = window.PptxGenJS?.default || window.PptxGenJS;
    if (!Pctor) return alert("PPT library missing. Run locally.");

    const pptx = new Pctor();

    /*************** EXACT SAMPLE LAYOUT REPLICATION ***************/
    const slide = pptx.addSlide();

    // Title
    slide.addText("IBM Power Timeline", {
      x: 0.5,
      y: 0.3,
      fontSize: 34,
      bold: true,
    });

    /* The uploaded PPT shows this structure:

      [DATE]
      Build / Ship
      You can edit the text...

      Text Title
      You can edit the text...

      End of Migration
      You can edit the text...

      --- then grouped again under title ---

      IBM Power Timeline
      [DATE]
      [DATE]
      [DATE]

      PO Received
      You can edit text...

    */

    const primaryBlock = [
      { date: fmt(timeline.buildShip), title: "Build / Ship" },
      { date: fmt(timeline.install), title: "Installation" },
      { date: fmt(timeline.endMigration), title: "End of Migration" },
    ];

    let y = 1.2;

    // First section — matches uploaded PPT
    primaryBlock.forEach((b) => {
      slide.addText(b.date, { x: 0.5, y, fontSize: 26, bold: true });
      slide.addText(b.title, { x: 0.5, y: y + 0.45, fontSize: 20, bold: true });
      slide.addText("You can edit the text for this timeline milestone.", {
        x: 0.5,
        y: y + 0.9,
        fontSize: 16,
      });
      y += 1.4;
    });

    // White space gap to mimic sample
    y += 0.3;

    // Sub-title group EXACTLY like sample
    slide.addText("Text Title", { x: 0.5, y, fontSize: 22, bold: true });
    slide.addText("You can edit the text for this timeline milestone.", {
      x: 0.5,
      y: y + 0.45,
      fontSize: 16,
    });

    y += 1.3;

    // Lower block — multiple dates stacked (matches sample)
    slide.addText(fmt(timeline.po), { x: 0.5, y, fontSize: 26, bold: true });
    slide.addText(fmt(timeline.buildShip), { x: 0.5, y: y + 0.45, fontSize: 26, bold: true });
    slide.addText(fmt(timeline.install), { x: 0.5, y: y + 0.9, fontSize: 26, bold: true });

    y += 1.6;

    // PO section
    slide.addText("PO Received", { x: 0.5, y, fontSize: 20, bold: true });
    slide.addText("You can edit the text for this timeline milestone.", {
      x: 0.5,
      y: y + 0.45,
      fontSize: 16,
    });

    try {
      await pptx.writeFile({ fileName: "IBM_Power_Timeline.pptx" });
    } catch (err) {
      console.error(err);
      alert("Failed to generate PPT");
    }
  };

  /****************************
   * Render
   ****************************/
  return (
    <div className="min-h-screen bg-gray-50 flex items-start justify-center p-8">
      <div className="w-full max-w-5xl bg-white shadow-2xl rounded-2xl overflow-hidden">
        <div className="bg-gradient-to-r from-blue-800 to-indigo-600 p-8 text-white">
          <h1 className="text-3xl font-extrabold">IBM Power — Timeline</h1>
        </div>

        <div className="p-8">
          {/* Step 1 */}
          {step === 1 && (
            <div className="space-y-6">
              {error && <p className="text-red-600">{error}</p>}

              <div className="flex space-x-6 items-center">
                <label className="flex items-center space-x-2">
                  <input
                    type="radio"
                    name="mode"
                    checked={mode === "po"}
                    onChange={() => {
                      setMode("po");
                      setForm((p) => ({ ...p, endMigrationDate: "" }));
                    }}
                  />
                  <span>PO Received Date</span>
                </label>

                <label className="flex items-center space-x-2">
                  <input
                    type="radio"
                    name="mode"
                    checked={mode === "end"}
                    onChange={() => {
                      setMode("end");
                      setForm((p) => ({ ...p, poDate: "" }));
                    }}
                  />
                  <span>End of Migration Date</span>
                </label>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {mode === "po" && (
                  <div>
                    <label className="block font-medium">PO Received Date</label>
                    <input
                      type="date"
                      name="poDate"
                      value={form.poDate}
                      onChange={handleChange}
                      className="mt-2 w-full p-3 border rounded-lg"
                    />
                  </div>
                )}

                {mode === "end" && (
                  <div>
                    <label className="block font-medium">End of Migration Date</label>
                    <input
                      type="date"
                      name="endMigrationDate"
                      value={form.endMigrationDate}
                      onChange={handleChange}
                      className="mt-2 w-full p-3 border rounded-lg"
                    />
                  </div>
                )}

                {/* Slider Groups */}
                {[
                  { key: "s1022", label: "# S1022/1122", max: 25 },
                  { key: "s1024", label: "# S1024/1124", max: 25 },
                  { key: "e1050", label: "# E1050/1150", max: 20 },
                  { key: "e1080", label: "# E1080/1180", max: 10 },
                  { key: "lpars", label: "LPAR Count", max: 200, step: 5 }
                ].map(({ key, label, max, step = 1 }) => (
                  <div key={key}>
                    <label className="block font-medium">{label} — <span className="text-indigo-600 font-bold">{form[key]}</span></label>
                    <input
                      type="range"
                      name={key}
                      min="0"
                      max={max}
                      step={step}
                      value={form[key]}
                      onChange={handleChange}
                      className="mt-2 w-full"
                    />
                  </div>
                ))}
              </div>

              <div className="flex justify-end">
                <button
                  onClick={generateTimeline}
                  className="px-6 py-2 bg-indigo-600 text-white rounded-md"
                >
                  Next
                </button>
              </div>
            </div>
          )}

          {/* Step 3 */}
          {step === 3 && timeline && (
            <div className="space-y-10">
              <h2 className="text-2xl font-semibold mb-10">Timeline Result</h2>

              <div className="relative w-full flex justify-between items-center px-6" style={{ marginTop: "80px" }}>
                <div className="absolute left-0 right-0 h-6 bg-gradient-to-r from-yellow-400 via-orange-400 via-purple-500 to-blue-900 rounded-full"></div>

                {[ 
                  { label: "PO Received", date: fmt(timeline.po), color: "bg-gradient-to-br from-yellow-300 to-yellow-500" },
                  { label: "Build / Ship", date: fmt(timeline.buildShip), color: "bg-gradient-to-br from-orange-300 to-orange-600" },
                  { label: "Installation", date: fmt(timeline.install), color: "bg-gradient-to-br from-purple-300 to-purple-600" },
                  { label: "End of Migration", date: fmt(timeline.endMigration), color: "bg-gradient-to-br from-blue-400 to-blue-900" }
                ].map((item, i) => (
                  <div key={i} className="relative z-10 flex flex-col items-center text-center" style={{ transform: "translateY(-40px)" }}>
                    <div className="w-32 h-32 rounded-full bg-white shadow-xl flex items-center justify-center border-4 border-gray-200">
                      <div className={`w-24 h-24 rounded-full flex items-center justify-center text-white font-bold text-sm ${item.color}`}>
                        {item.date}
                      </div>
                    </div>
                    <p className="mt-4 text-gray-700 font-semibold text-sm">{item.label}</p>
                  </div>
                ))}
              </div>

              <div className="flex justify-between mt-10">
                <button
                  onClick={() => setStep(1)}
                  className="px-6 py-2 border rounded-md"
                >
                  Back
                </button>

                <div className="flex items-center space-x-3">
                  <button
                    onClick={() => { setStep(1); setTimeline(null); }}
                    className="px-6 py-2 border rounded-md"
                  >
                    Start Over
                  </button>

                  <button
                    onClick={downloadPPT}
                    className="px-6 py-2 bg-indigo-600 text-white rounded-md"
                  >
                    Download PPT
                  </button>
                </div>
              </div>
            </div>
          )}

        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root"))
  .render(<IBMWizard />);
</script>
</body>
</html>
