const downloadPPT = async () => {
    if (!timeline) return alert("Generate the timeline first.");

    const Pctor = window.PptxGenJS?.default || window.PptxGenJS;
    if (!Pctor) return alert("PPT library missing. Run locally.");

    const pptx = new Pctor();
    const slide = pptx.addSlide();

    // Title
    slide.addText("IBM Power Timeline", {
      x: 0, y: 0.3, w: 10, fontSize: 36, bold: true, align: "center", color: "000000"
    });

    // Define positions for the 4 main milestone circles
    const centerY = 3.0;
    const circleSize = 0.6;
    const positions = [
      { x: 1.8, label: "PO", color: "E67E22" },      // Orange
      { x: 4.0, label: "Build", color: "9B59B6" },   // Purple
      { x: 6.2, label: "Install", color: "3498DB" }, // Blue
      { x: 8.4, label: "End", color: "E74C3C" }      // Red
    ];

    // Draw connector lines between circles
    // Orange line: PO to Build (curved down)
    slide.addShape(pptx.ShapeType.line, {
      x: positions[0].x + circleSize/2, y: centerY + circleSize/2,
      w: 1.2, h: 0.4,
      line: { color: positions[0].color, width: 4 }
    });
    
    // Purple line: Build horizontal
    slide.addShape(pptx.ShapeType.line, {
      x: positions[1].x + circleSize, y: centerY + circleSize/2,
      w: 1.4, h: 0,
      line: { color: positions[1].color, width: 4 }
    });
    
    // Blue line: Install to End (curved down)
    slide.addShape(pptx.ShapeType.line, {
      x: positions[2].x + circleSize, y: centerY + circleSize/2,
      w: 1.4, h: 0.4,
      line: { color: positions[2].color, width: 4 }
    });
    
    // Red line: from End circle
    slide.addShape(pptx.ShapeType.line, {
      x: positions[3].x + circleSize, y: centerY + circleSize/2,
      w: 0.8, h: 0,
      line: { color: positions[3].color, width: 4 }
    });

    // Vertical lines to upper labels
    slide.addShape(pptx.ShapeType.line, {
      x: positions[1].x + circleSize/2, y: centerY - 0.2,
      w: 0, h: 1.2,
      line: { color: positions[1].color, width: 4 }
    });
    
    slide.addShape(pptx.ShapeType.line, {
      x: positions[3].x + circleSize/2, y: centerY - 0.2,
      w: 0, h: 1.2,
      line: { color: positions[3].color, width: 4 }
    });

    // Vertical lines to lower labels
    slide.addShape(pptx.ShapeType.line, {
      x: positions[0].x + circleSize/2, y: centerY + circleSize,
      w: 0, h: 1.0,
      line: { color: positions[0].color, width: 4 }
    });
    
    slide.addShape(pptx.ShapeType.line, {
      x: positions[2].x + circleSize/2, y: centerY + circleSize,
      w: 0, h: 1.0,
      line: { color: positions[2].color, width: 4 }
    });

    // Draw the 4 main white circles with colored borders
    positions.forEach((pos) => {
      slide.addShape(pptx.ShapeType.ellipse, {
        x: pos.x, y: centerY,
        w: circleSize, h: circleSize,
        fill: { color: "FFFFFF" },
        line: { color: "DDDDDD", width: 2 }
      });
      
      // Add icon placeholder circles (smaller, colored)
      slide.addShape(pptx.ShapeType.ellipse, {
        x: pos.x + 0.15, y: centerY + 0.15,
        w: 0.3, h: 0.3,
        fill: { color: pos.color }
      });
    });

    // Endpoint circles (small dots)
    slide.addShape(pptx.ShapeType.ellipse, {
      x: positions[0].x + circleSize/2 - 0.08, y: centerY + circleSize + 0.92,
      w: 0.16, h: 0.16,
      fill: { color: positions[0].color }
    });
    
    slide.addShape(pptx.ShapeType.ellipse, {
      x: positions[2].x + circleSize/2 - 0.08, y: centerY + circleSize + 0.92,
      w: 0.16, h: 0.16,
      fill: { color: positions[2].color }
    });

    // TOP LABELS - Build/Ship
    slide.addText("Build / Ship", {
      x: positions[1].x - 0.5, y: 1.3, w: 1.6, 
      fontSize: 13, bold: true, color: positions[1].color, align: "center"
    });
    slide.addText("You can edit the text for\nthis timeline milestone.", {
      x: positions[1].x - 0.7, y: 1.55, w: 2.0, 
      fontSize: 8, color: "666666", align: "center"
    });

    // TOP LABELS - End of Migration
    slide.addText("End of Migration", {
      x: positions[3].x - 0.5, y: 1.3, w: 1.6, 
      fontSize: 13, bold: true, color: positions[3].color, align: "center"
    });
    slide.addText("You can edit the text for\nthis timeline milestone.", {
      x: positions[3].x - 0.7, y: 1.55, w: 2.0, 
      fontSize: 8, color: "666666", align: "center"
    });

    // DATE LABELS (italicized brackets with actual dates)
    slide.addText(`[DATE OF PO RECEIVED]`, {
      x: positions[0].x - 0.6, y: 2.3, w: 1.8, 
      fontSize: 10, bold: true, italic: true, color: "333333", align: "center"
    });
    slide.addText(fmt(timeline.po), {
      x: positions[0].x - 0.6, y: 2.52, w: 1.8, 
      fontSize: 10, bold: true, color: "333333", align: "center"
    });

    slide.addText(`[DATE OF BUILD / SHIP]`, {
      x: positions[1].x - 0.6, y: 3.7, w: 1.8, 
      fontSize: 10, bold: true, italic: true, color: "333333", align: "center"
    });
    slide.addText(fmt(timeline.buildShip), {
      x: positions[1].x - 0.6, y: 3.92, w: 1.8, 
      fontSize: 10, bold: true, color: "333333", align: "center"
    });

    slide.addText(`[DATE OF INSTALLATION]`, {
      x: positions[2].x - 0.6, y: 2.3, w: 1.8, 
      fontSize: 10, bold: true, italic: true, color: "333333", align: "center"
    });
    slide.addText(fmt(timeline.install), {
      x: positions[2].x - 0.6, y: 2.52, w: 1.8, 
      fontSize: 10, bold: true, color: "333333", align: "center"
    });

    slide.addText(`[DATE OF END OF MIGRATION]`, {
      x: positions[3].x - 0.8, y: 3.7, w: 2.2, 
      fontSize: 10, bold: true, italic: true, color: "333333", align: "center"
    });
    slide.addText(fmt(timeline.endMigration), {
      x: positions[3].x - 0.8, y: 3.92, w: 2.2, 
      fontSize: 10, bold: true, color: "333333", align: "center"
    });

    // BOTTOM LABELS - PO Received
    slide.addText("PO Received", {
      x: positions[0].x - 0.5, y: 4.5, w: 1.6, 
      fontSize: 13, bold: true, color: positions[0].color, align: "center"
    });
    slide.addText("You can edit the text for\nthis timeline milestone.", {
      x: positions[0].x - 0.7, y: 4.75, w: 2.0, 
      fontSize: 8, color: "666666", align: "center"
    });

    // BOTTOM LABELS - Installation
    slide.addText("Installation", {
      x: positions[2].x - 0.5, y: 4.5, w: 1.6, 
      fontSize: 13, bold: true, color: positions[2].color, align: "center"
    });
    slide.addText("You can edit the text for\nthis timeline milestone.", {
      x: positions[2].x - 0.7, y: 4.75, w: 2.0, 
      fontSize: 8, color: "666666", align: "center"
    });

    try {
      await pptx.writeFile({ fileName: "IBM_Power_Timeline.pptx" });
    } catch (err) {
      console.error(err);
      alert("Failed to generate PPT");
    }
  };
